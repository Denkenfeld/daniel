<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Drug Discovery Sim 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap');

        body { 
            background: #050b14; 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            margin: 0;
        }

        /* UI Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .hud-text { font-family: 'JetBrains Mono', monospace; }

        /* Custom Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            cursor: pointer;
            margin-top: -8px;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        /* Custom Scrollbar for side panel */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        #canvas-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
        }
        
        .overlay-ui { position: relative; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px #10b981; }
            50% { box-shadow: 0 0 25px #10b981; }
        }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body>

<div id="canvas-wrapper"></div>

<div class="overlay-ui flex flex-col h-screen p-4 md:p-6 justify-between">

    <header class="flex justify-between items-start pointer-events-auto">
        <div class="glass-panel p-4 rounded-2xl border-l-4 border-blue-500">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">
                BioSim: Wirkstoff-Designer
            </h1>
            <p class="text-xs text-slate-400 mt-1 max-w-md">
                Simuliere den Weg einer Tablette durch das Blut. Ziel: Bringe genug Wirkstoff zum Rezeptor (unten), ohne dass er zerstört oder abgefangen wird.
            </p>
        </div>
        
        <div class="glass-panel p-4 rounded-2xl text-right min-w-[200px]">
            <div class="text-xs uppercase tracking-widest text-slate-500 mb-1">Therapie-Erfolg</div>
            <div class="flex items-end justify-end gap-2">
                <span id="score-val" class="text-4xl font-bold text-white hud-text">0</span>
                <span class="text-sm text-slate-400 mb-1">%</span>
            </div>
            <div class="w-full bg-slate-800 h-2 rounded-full mt-2 overflow-hidden">
                <div id="score-bar" class="h-full bg-gradient-to-r from-red-500 to-emerald-500 w-0 transition-all duration-500"></div>
            </div>
            <div id="score-text" class="text-xs mt-2 font-bold text-red-400">Unwirksam</div>
        </div>
    </header>

    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0" id="feedback-msg">
        <h2 class="text-5xl font-bold text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">TEXT</h2>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-auto pointer-events-none">
        
        <div class="lg:col-span-3 glass-panel rounded-2xl p-6 pointer-events-auto space-y-8 overflow-y-auto max-h-[60vh]">
            
            <div class="group">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-blue-400 flex items-center gap-2">
                        <i class="fas fa-magnet"></i> Eiweiß-Bindung
                    </label>
                    <span id="val-binding" class="text-xs bg-slate-800 px-2 py-1 rounded">Mittel</span>
                </div>
                <input type="range" id="input-binding" min="0" max="100" value="50" class="accent-blue-500">
                <p class="text-xs text-slate-400 mt-2 leading-relaxed">
                    <strong class="text-white">Wie Magnete:</strong> Blutproteine fangen das Medikament. Wenn es klebt, kann es nicht wirken.
                    <br><span class="text-blue-300">Ziel: Niedrig halten, damit es frei schwimmt.</span>
                </p>
            </div>

            <div class="group">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-red-400 flex items-center gap-2">
                        <i class="fas fa-skull"></i> Stoffwechsel (Leber)
                    </label>
                    <span id="val-metab" class="text-xs bg-slate-800 px-2 py-1 rounded">Niedrig</span>
                </div>
                <input type="range" id="input-metabolism" min="0" max="100" value="20" class="accent-red-500">
                <p class="text-xs text-slate-400 mt-2 leading-relaxed">
                    <strong class="text-white">Der Schredder:</strong> Enzyme zerstören den Wirkstoff. 
                    <br><span class="text-red-300">Zu hoch? Das Medikament wird sofort vernichtet.</span>
                </p>
            </div>

            <div class="group">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-amber-400 flex items-center gap-2">
                        <i class="fas fa-door-closed"></i> Efflux Pumpe
                    </label>
                    <span id="val-efflux" class="text-xs bg-slate-800 px-2 py-1 rounded">Niedrig</span>
                </div>
                <input type="range" id="input-efflux" min="0" max="100" value="10" class="accent-amber-500">
                <p class="text-xs text-slate-400 mt-2 leading-relaxed">
                    <strong class="text-white">Der Türsteher:</strong> Pumpt das Medikament wieder aus der Zelle raus, bevor es wirken kann.
                </p>
            </div>
        </div>

        <div class="lg:col-span-6 flex flex-col justify-end items-center pb-6">
            <div class="glass-panel px-6 py-3 rounded-full flex gap-6 pointer-events-auto">
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-3 h-3 rounded-full bg-cyan-400 shadow-[0_0_10px_#22d3ee]"></span> Wirkstoff
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-3 h-3 rounded-full border border-blue-500"></span> Protein
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-3 h-3 rounded-full bg-gray-600"></span> Inaktiv
                </div>
                <div class="flex items-center gap-2 text-xs text-emerald-400 font-bold">
                    <i class="fas fa-arrow-down"></i> Ziel: Unten
                </div>
            </div>
        </div>

        <div class="lg:col-span-3 glass-panel rounded-2xl p-6 pointer-events-auto flex flex-col">
            <h3 class="font-bold text-slate-300 mb-4 text-sm">Konzentration im Blut</h3>
            <div class="flex-grow min-h-[150px]">
                <canvas id="pkChart"></canvas>
            </div>
            <div class="mt-4 border-t border-slate-700 pt-4 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Halbwertszeit:</span>
                    <span id="stat-t12" class="font-mono text-white">4.2h</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Bioverfügbarkeit:</span>
                    <span id="stat-bio" class="font-mono text-emerald-400">85%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * --- 1. SETUP & SCENE ---
     * Wir bauen eine Blutbahn mit "Unreal Bloom" Effekt für Sci-Fi Look.
     */
    const container = document.getElementById('canvas-wrapper');
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050b14, 0.02); // Tiefeneffekt

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 0, 18);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ReinhardToneMapping;
    container.appendChild(renderer.domElement);

    // POST-PROCESSING (Der "Glow")
    const renderScene = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.threshold = 0.1;
    bloomPass.strength = 1.2; // Wie stark es leuchtet
    bloomPass.radius = 0.5;

    const composer = new THREE.EffectComposer(renderer);
    composer.addPass(renderScene);
    composer.addPass(bloomPass);

    // LICHT
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    
    const blueLight = new THREE.PointLight(0x3b82f6, 2, 50);
    blueLight.position.set(10, 10, 10);
    scene.add(blueLight);

    const purpleLight = new THREE.PointLight(0xa855f7, 2, 50);
    purpleLight.position.set(-10, -5, 5);
    scene.add(purpleLight);

    /**
     * --- 2. OBJEKTE ERSTELLEN ---
     */
    
    // a) Die Blutbahn (Hintergrund-Partikel)
    const bloodParticlesGeo = new THREE.BufferGeometry();
    const bloodCount = 400;
    const bloodPos = new Float32Array(bloodCount * 3);
    for(let i=0; i<bloodCount*3; i++) {
        bloodPos[i] = (Math.random() - 0.5) * 60;
    }
    bloodParticlesGeo.setAttribute('position', new THREE.BufferAttribute(bloodPos, 3));
    const bloodMat = new THREE.PointsMaterial({ color: 0x334155, size: 0.1, transparent: true, opacity: 0.5 });
    const bloodSystem = new THREE.Points(bloodParticlesGeo, bloodMat);
    scene.add(bloodSystem);

    // b) Das Ziel-Gewebe (Unten)
    const tissueGeo = new THREE.PlaneGeometry(100, 20);
    const tissueMat = new THREE.MeshStandardMaterial({ 
        color: 0x000000, 
        emissive: 0x10b981, 
        emissiveIntensity: 0.2,
        transparent: true, opacity: 0.8 
    });
    const tissue = new THREE.Mesh(tissueGeo, tissueMat);
    tissue.rotation.x = -Math.PI / 2;
    tissue.position.y = -6;
    scene.add(tissue);
    
    // Gitter auf dem Zielgewebe
    const gridHelper = new THREE.GridHelper(100, 50, 0x10b981, 0x064e3b);
    gridHelper.position.y = -5.9;
    scene.add(gridHelper);

    // c) Proteine (Die großen Blobs)
    const proteins = [];
    const proteinGeo = new THREE.IcosahedronGeometry(1.2, 0); // Low poly look
    const proteinMat = new THREE.MeshStandardMaterial({ 
        color: 0x1e293b, 
        roughness: 0.3, 
        metalness: 0.8,
        emissive: 0x3b82f6,
        emissiveIntensity: 0.4,
        flatShading: true
    });

    for(let i=0; i<8; i++) {
        const p = new THREE.Mesh(proteinGeo, proteinMat);
        p.position.set(
            (Math.random() - 0.5) * 30,
            (Math.random() - 0.5) * 6,
            (Math.random() - 0.5) * 5
        );
        p.userData = { 
            rotSpeed: { x: Math.random()*0.02, y: Math.random()*0.02 },
            floatSpeed: Math.random() * 0.02 + 0.01
        };
        scene.add(p);
        proteins.push(p);
    }

    // d) Medikamente (Die Wirkstoffe)
    const drugs = [];
    const drugGeo = new THREE.SphereGeometry(0.15, 8, 8);
    const drugMat = new THREE.MeshBasicMaterial({ color: 0x22d3ee }); // Cyan Glow
    
    // Pool von Medikamenten erstellen
    for(let i=0; i<150; i++) {
        const d = new THREE.Mesh(drugGeo, drugMat.clone());
        resetDrug(d);
        scene.add(d);
        drugs.push(d);
    }

    function resetDrug(d) {
        d.position.set(-25 - Math.random() * 10, (Math.random() - 0.5) * 6, (Math.random() - 0.5) * 2);
        d.material.color.setHex(0x22d3ee);
        d.material.opacity = 1;
        d.material.transparent = false;
        d.scale.set(1,1,1);
        d.userData = {
            state: 'free', // free, bound, dead, success, effluxed
            speed: 0.08 + Math.random() * 0.05,
            boundTo: null,
            offset: new THREE.Vector3()
        };
    }

    /**
     * --- 3. SIMULATIONS-LOGIK ---
     */
    const params = {
        bindingChance: 0.5, // 0 to 1
        metabChance: 0.2,   // 0 to 1
        effluxChance: 0.1   // 0 to 1
    };

    let activeMolecules = 0;
    let successCount = 0;
    let totalSimulated = 0;

    function updateSimulation() {
        activeMolecules = 0;

        // 1. Blutfluss Animation
        bloodSystem.rotation.x += 0.001;
        bloodSystem.position.x += 0.05;
        if(bloodSystem.position.x > 5) bloodSystem.position.x = 0;

        // 2. Proteine bewegen
        proteins.forEach(p => {
            p.rotation.x += p.userData.rotSpeed.x;
            p.rotation.y += p.userData.rotSpeed.y;
            p.position.x += 0.02; // Proteine fließen langsam mit
            if (p.position.x > 25) p.position.x = -25;
        });

        // 3. Medikamente bewegen & Logik
        drugs.forEach(d => {
            
            // --- STATE: BOUND (Klebt am Protein) ---
            if (d.userData.state === 'bound') {
                const p = d.userData.boundTo;
                // Position relativ zum Protein halten + Rotation
                const newPos = p.position.clone().add(d.userData.offset.applyEuler(new THREE.Euler(0.01, 0.01, 0)));
                d.position.copy(newPos);
                
                // Protein verlässt Bildschirm? Reset.
                if (p.position.x > 25) {
                    resetDrug(d);
                }
                return; // Keine weitere Logik für gebundene
            }

            // --- STATE: DEAD / SUCCESS (Animation beenden) ---
            if (d.userData.state === 'dead' || d.userData.state === 'success') {
                d.material.opacity -= 0.02;
                if(d.material.opacity <= 0) resetDrug(d);
                return;
            }

            // --- STATE: FREE (Bewegung) ---
            d.position.x += d.userData.speed;

            // A. Check: Metabolismus (Der Schredder)
            // Nur wenn noch nicht zu weit rechts
            if (Math.random() < params.metabChance * 0.02 && d.position.x < 10) {
                d.userData.state = 'dead';
                d.material.color.setHex(0x334155); // Grau
                d.scale.set(0.5, 0.5, 0.5);
                return;
            }

            // B. Check: Protein Bindung
            // Prüfe Abstand zu allen Proteinen
            for (let p of proteins) {
                if (d.position.distanceTo(p.position) < 1.5) {
                    if (Math.random() < params.bindingChance * 0.3) { // * Faktor zur Dämpfung
                        d.userData.state = 'bound';
                        d.userData.boundTo = p;
                        d.userData.offset = d.position.clone().sub(p.position);
                        d.material.color.setHex(0x60a5fa); // Blau
                        return;
                    }
                }
            }

            // C. Check: Diffusion zum Ziel (Membran passieren)
            // Passiert zufällig, wenn "frei"
            if (d.position.x > -5 && d.position.x < 15) {
                // Versuch, nach unten zu diffundieren
                d.position.y -= 0.05;

                // Membran erreicht?
                if (d.position.y < -4) {
                    // EFFLUX CHECK (Der Türsteher)
                    if (Math.random() < params.effluxChance) {
                        // Rausgeworfen!
                        d.userData.state = 'effluxed';
                        gsap.to(d.position, { y: 2, duration: 0.5, ease: "back.out(1.7)" });
                        d.material.color.setHex(0xf59e0b); // Orange Warnung
                    } else {
                        // ERFOLG!
                        d.userData.state = 'success';
                        d.material.color.setHex(0x10b981); // Grün
                        gsap.to(d.scale, { x: 2, y: 2, z: 2, duration: 0.2 }); // Aufleuchten
                        
                        // Impact Effekt auf dem Boden
                        const impact = new THREE.Mesh(
                            new THREE.RingGeometry(0.1, 1, 32),
                            new THREE.MeshBasicMaterial({ color: 0x10b981, transparent: true, opacity: 0.8, side: THREE.DoubleSide })
                        );
                        impact.rotation.x = -Math.PI/2;
                        impact.position.set(d.position.x, -5.8, d.position.z);
                        scene.add(impact);
                        gsap.to(impact.scale, { x: 3, y: 3, duration: 0.5 });
                        gsap.to(impact.material, { opacity: 0, duration: 0.5, onComplete: () => scene.remove(impact) });

                        successCount++;
                    }
                }
            }

            // Reset wenn aus dem Bild
            if (d.position.x > 25) resetDrug(d);
        });

        // Rolling Average für Score berechnen (simuliert)
        totalSimulated++;
        if(totalSimulated > 1000) { totalSimulated = 0; successCount = 0; } // Reset counters ab und zu
    }

    /**
     * --- 4. UI & LOGIK VERKNÜPFUNG ---
     */
    
    // Sliders
    const slBind = document.getElementById('input-binding');
    const slMetab = document.getElementById('input-metabolism');
    const slEfflux = document.getElementById('input-efflux');

    // Chart
    const ctx = document.getElementById('pkChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 24}, (_, i) => i + "h"),
            datasets: [{
                label: 'Plasma Konzentration',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false, min: 0, max: 100 },
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {size: 10} } }
            },
            animation: { duration: 0 } // Performance
        }
    });

    function updateLogic() {
        // Update Globals
        params.bindingChance = parseInt(slBind.value) / 100;
        params.metabChance = parseInt(slMetab.value) / 100;
        params.effluxChance = parseInt(slEfflux.value) / 100;

        // Update Labels
        document.getElementById('val-binding').innerText = params.bindingChance < 0.3 ? "Niedrig" : params.bindingChance > 0.7 ? "Hoch" : "Mittel";
        document.getElementById('val-metab').innerText = params.metabChance < 0.3 ? "Stabil" : "Instabil";
        document.getElementById('val-efflux').innerText = params.effluxChance < 0.2 ? "Gering" : "Stark";

        // Berechne "Score" (Vereinfachte DMPK Formel)
        // Erfolg = (1 - Bindung) * (1 - Metab) * (1 - Efflux)
        // Aber Bindung ist nicht linear tödlich, sondern verlangsamt eher.
        
        const freeFraction = 1 - params.bindingChance;
        const stability = 1 - params.metabChance;
        const absorption = 1 - params.effluxChance;

        const effectiveScore = (freeFraction * stability * absorption * 100).toFixed(0);
        
        // Update Score UI
        const scoreEl = document.getElementById('score-val');
        const scoreBar = document.getElementById('score-bar');
        const scoreText = document.getElementById('score-text');
        
        // Animate Numbers
        const oldVal = parseInt(scoreEl.innerText);
        if(Math.abs(oldVal - effectiveScore) > 1) {
            scoreEl.innerText = effectiveScore;
        }

        scoreBar.style.width = effectiveScore + "%";
        
        // Farbe und Text ändern
        tissueMat.emissiveIntensity = effectiveScore / 100; // Ziel leuchtet heller wenn gut

        if (effectiveScore > 75) {
            scoreBar.className = "h-full bg-emerald-500 shadow-[0_0_15px_#10b981]";
            scoreText.innerText = "EXZELLENTER KANDIDAT";
            scoreText.className = "text-xs mt-2 font-bold text-emerald-400";
        } else if (effectiveScore > 35) {
            scoreBar.className = "h-full bg-yellow-400";
            scoreText.innerText = "AKZEPTABEL / OPTIMIERUNG NÖTIG";
            scoreText.className = "text-xs mt-2 font-bold text-yellow-400";
        } else {
            scoreBar.className = "h-full bg-red-500";
            scoreText.innerText = "KLINISCHES VERSAGEN WAHRSCHEINLICH";
            scoreText.className = "text-xs mt-2 font-bold text-red-500";
        }

        // Update Stats Text
        const t12 = (10 / (params.metabChance + 0.1)).toFixed(1);
        document.getElementById('stat-t12').innerText = t12 + "h";
        document.getElementById('stat-bio').innerText = effectiveScore + "%";

        // Update Chart Curve
        const newData = [];
        let conc = 100;
        // Zerfallskonstante k
        const k = (params.metabChance * 0.8) + (params.effluxChance * 0.2) + 0.05;
        // Peak Dämpfung durch Proteinbindung
        conc = conc * (1 - (params.bindingChance * 0.5)); 

        for(let i=0; i<24; i++) {
            newData.push(conc);
            conc = conc * (1 - k);
        }
        chart.data.datasets[0].data = newData;
        chart.update();
    }

    // Event Listeners
    [slBind, slMetab, slEfflux].forEach(el => el.addEventListener('input', updateLogic));

    // Resize Handler
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    });

    /**
     * --- MAIN LOOP ---
     */
    function animate() {
        requestAnimationFrame(animate);
        updateSimulation();
        // renderer.render(scene, camera); // Ohne Glow
        composer.render(); // Mit Glow
    }

    // Init
    updateLogic();
    animate();

    // Intro Animation
    gsap.from(".glass-panel", {
        y: 50, opacity: 0, duration: 1, stagger: 0.2, ease: "power3.out"
    });

</script>
</body>
</html>
