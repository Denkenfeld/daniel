<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced DMPK Explorer 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background: #0f172a; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px; background: #38bdf8; cursor: pointer; border-radius: 50%;
        }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<div class="relative z-10 container mx-auto p-6 flex flex-col min-h-screen">
    
    <header class="flex justify-between items-center mb-8 glass p-6 rounded-2xl">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                DMPK Pro: Drug Discovery Sim
            </h1>
            <p class="text-slate-400 text-sm">PrÃ¤klinische Pharmakokinetik & Dynamik</p>
        </div>
        <div class="text-right">
            <div class="text-xs uppercase tracking-widest text-slate-500">Status</div>
            <div id="status-tag" class="text-emerald-400 font-mono">OPTIMAL CANDIDATE</div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
        
        <div class="lg:col-span-1 space-y-6">
            
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-blue-400 font-bold mb-4 flex items-center">
                    <span class="mr-2">ðŸ§ª</span> 1. Metabolische StabilitÃ¤t
                </h3>
                <input type="range" id="input-metabolism" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" value="20">
                <div class="flex justify-between text-xs mt-2 text-slate-400">
                    <span>Stabil (T 1/2 > 120min)</span>
                    <span>Instabil (Clearance hoch)</span>
                </div>
                <p class="mt-4 text-xs text-slate-300">Bestimmt, wie schnell Enzyme (CYP) das MolekÃ¼l in inaktive Metaboliten umwandeln.</p>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-emerald-400 font-bold mb-4 flex items-center">
                    <span class="mr-2">ðŸ”—</span> 2. Plasmaproteinbindung (PPB)
                </h3>
                <input type="range" id="input-binding" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" value="70">
                <div class="flex justify-between text-xs mt-2 text-slate-400">
                    <span>Niedrig (f<sub>u</sub> hoch)</span>
                    <span>Hoch (>99%)</span>
                </div>
                <p class="mt-4 text-xs text-slate-300">Nur ungebundene MolekÃ¼le kÃ¶nnen durch Membranen diffundieren. "The Free Drug Hypothesis".</p>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-amber-400 font-bold mb-4 flex items-center">
                    <span class="mr-2">ðŸšª</span> 3. Transporter (Efflux Ratio)
                </h3>
                <input type="range" id="input-transporter" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" value="10">
                <div class="flex justify-between text-xs mt-2 text-slate-400">
                    <span>Passive Diffusion</span>
                    <span>P-gp Efflux (Auspumpen)</span>
                </div>
                <p class="mt-4 text-xs text-slate-300">P-Glykoprotein (P-gp) pumpt Wirkstoffe aktiv aus der Zelle heraus â€“ ein Hauptgrund fÃ¼r Wirkverlust.</p>
            </div>
        </div>

        <div class="lg:col-span-1 flex items-end justify-center pb-10">
            <div class="text-center glass p-4 rounded-xl border-blue-500/30">
                <p class="text-xs text-slate-400 mb-1">Live View</p>
                <div class="flex gap-4 items-center">
                    <span class="flex items-center text-xs"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Active Drug</span>
                    <span class="flex items-center text-xs"><span class="w-3 h-3 bg-gray-500 rounded-full mr-1"></span> Metabolite</span>
                    <span class="flex items-center text-xs"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span> Protein</span>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
            <div class="glass p-6 rounded-2xl h-full flex flex-col">
                <h3 class="font-bold text-white mb-4">Pharmakokinetisches Profil</h3>
                
                <div class="flex-grow">
                    <canvas id="pkChart"></canvas>
                </div>

                <div class="mt-6 space-y-4 text-sm">
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="text-slate-400">V<sub>d</sub> (Verteilungsvolumen)</span>
                        <span id="val-vd" class="font-mono">L/kg</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="text-slate-400">BioverfÃ¼gbarkeit (F)</span>
                        <span id="val-f" class="font-mono text-emerald-400">-- %</span>
                    </div>
                    <p id="clinical-insight" class="text-xs italic text-blue-300 mt-4 leading-relaxed">
                        VerÃ¤ndere die Regler, um die Wirkstoffaufnahme zu simulieren.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/** * --- 3D ENGINE (THREE.JS) ---
 */
let scene, camera, renderer, molecules = [], proteins = [];
const container = document.getElementById('canvas-container');

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // Lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const pointLight = new THREE.PointLight(0x38bdf8, 1);
    pointLight.position.set(10, 10, 10);
    scene.add(pointLight);

    // Create Blood Vessel (Transparent Tube)
    const tubeGeo = new THREE.CylinderGeometry(5, 5, 40, 32, 1, true);
    const tubeMat = new THREE.MeshPhongMaterial({ 
        color: 0x1e293b, 
        transparent: true, 
        opacity: 0.2, 
        side: THREE.DoubleSide,
        wireframe: true 
    });
    const tube = new THREE.Mesh(tubeGeo, tubeMat);
    tube.rotation.z = Math.PI / 2;
    scene.add(tube);

    // Create Membrane (Plane at the bottom)
    const memGeo = new THREE.PlaneGeometry(40, 10);
    const memMat = new THREE.MeshPhongMaterial({ color: 0x334155, side: THREE.DoubleSide, transparent: true, opacity: 0.5 });
    const membrane = new THREE.Mesh(memGeo, memMat);
    membrane.rotation.x = Math.PI / 2;
    membrane.position.y = -4;
    scene.add(membrane);

    spawnMolecules();
    spawnProteins();

    camera.position.z = 15;
    camera.position.y = 2;
}

function spawnMolecules() {
    const geo = new THREE.SphereGeometry(0.15, 16, 16);
    for(let i=0; i<150; i++) {
        const mat = new THREE.MeshPhongMaterial({ color: 0xef4444 }); // Drug color
        const sphere = new THREE.Mesh(geo, mat);
        resetMolecule(sphere);
        sphere.userData = { 
            speed: 0.05 + Math.random() * 0.1,
            state: 'active', // active, bound, metabolite, diffused
            originalColor: 0xef4444
        };
        scene.add(sphere);
        molecules.push(sphere);
    }
}

function resetMolecule(m) {
    m.position.set(-20 - Math.random() * 10, (Math.random()-0.5) * 6, (Math.random()-0.5) * 6);
    m.material.color.setHex(0xef4444);
    m.userData.state = 'active';
}

function spawnProteins() {
    const geo = new THREE.IcosahedronGeometry(0.6, 1);
    const mat = new THREE.MeshPhongMaterial({ color: 0x3b82f6, wireframe: true });
    for(let i=0; i<15; i++) {
        const p = new THREE.Mesh(geo, mat);
        p.position.set((Math.random()-0.5) * 30, (Math.random()-0.5) * 5, (Math.random()-0.5) * 5);
        scene.add(p);
        proteins.push(p);
    }
}

/**
 * --- SIMULATION LOGIC ---
 */
let metabRate = 0.2, bindRate = 0.7, effluxRate = 0.1;

function updateSim() {
    metabRate = document.getElementById('input-metabolism').value / 100;
    bindRate = document.getElementById('input-binding').value / 100;
    effluxRate = document.getElementById('input-transporter').value / 100;

    molecules.forEach(m => {
        // 1. Movement
        m.position.x += m.userData.speed;

        // 2. Binding Logic (Only if not already metabolized)
        if (m.userData.state === 'active') {
            proteins.forEach(p => {
                const dist = m.position.distanceTo(p.position);
                if (dist < 1.0 && Math.random() < bindRate * 0.2) {
                    m.userData.state = 'bound';
                    m.material.color.setHex(0x3b82f6);
                }
            });
        }

        // 3. Metabolism Logic (Only for free drug)
        if (m.userData.state === 'active' && Math.random() < metabRate * 0.005) {
            m.userData.state = 'metabolite';
            m.material.color.setHex(0x64748b);
        }

        // 4. Diffusion / Efflux Logic
        if (m.userData.state === 'active' && m.position.y < -3.5) {
            if (Math.random() > effluxRate) {
                // Pass through membrane
                m.userData.state = 'diffused';
                m.material.color.setHex(0x10b981);
                gsap.to(m.position, { y: -8, duration: 1 });
            } else {
                // Efflux: Bounce back up
                m.userData.state = 'active';
                gsap.to(m.position, { y: 2, duration: 0.5, ease: "power2.out" });
            }
        }

        // Reset when out of view
        if (m.position.x > 20) resetMolecule(m);
    });

    updateUI();
}

/**
 * --- UI & CHARTING ---
 */
let pkChart;
function initChart() {
    const ctx = document.getElementById('pkChart').getContext('2d');
    pkChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 20}, (_, i) => i),
            datasets: [{
                label: 'Plasmakonzentration (Cp)',
                borderColor: '#38bdf8',
                data: [],
                fill: true,
                backgroundColor: 'rgba(56, 189, 248, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { display: false, min: 0, max: 100 },
                x: { display: false }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function updateUI() {
    // Bioavailability F = (1-ER) * (1-Metab) -> Simplified logic
    const f = Math.max(0, (100 - (metabRate * 80) - (effluxRate * 40))).toFixed(1);
    document.getElementById('val-f').innerText = f + " %";
    
    const vd = (1.2 + (bindRate * 5)).toFixed(2);
    document.getElementById('val-vd').innerText = vd + " L/kg";

    // Dynamic Chart Update
    const newData = [];
    let tempVal = 100;
    const decay = (metabRate * 0.5) + 0.05;
    for(let i=0; i<20; i++) {
        newData.push(tempVal);
        tempVal *= (1 - decay);
    }
    pkChart.data.datasets[0].data = newData;
    pkChart.update('none');

    // Status & Insights
    const status = document.getElementById('status-tag');
    const insight = document.getElementById('clinical-insight');

    if (f < 20) {
        status.innerText = "POOR BIOAVAILABILITY";
        status.className = "text-red-500 font-mono";
        insight.innerText = "Warnung: Hoher First-Pass-Effekt oder starker Efflux. Substanz erreicht Wirkort nicht.";
    } else if (bindRate > 0.9) {
        status.innerText = "HIGH PROTEIN BINDING";
        status.className = "text-amber-400 font-mono";
        insight.innerText = "Starke PPB: Lange Halbwertszeit, aber geringe freie Konzentration am Rezeptor.";
    } else {
        status.innerText = "OPTIMAL CANDIDATE";
        status.className = "text-emerald-400 font-mono";
        insight.innerText = "Ausgewogenes DMPK-Profil. Gute Chance auf therapeutisches Fenster.";
    }
}

// Animation Loop
function animate() {
    requestAnimationFrame(animate);
    updateSim();
    renderer.render(scene, camera);
}

// Resize Handling
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// Start
init3D();
initChart();
animate();

</script>
</body>
</html>
