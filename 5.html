<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaFlow - Test Order Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }

        /* Chart Container Fix */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* DMPK Modal Styles */
        .dmpk-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .dmpk-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dmpk-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 1400px;
            width: 100%;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            display: grid;
            grid-template-columns: 360px 1fr;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .dmpk-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10000;
        }

        .dmpk-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* Order Details Modal */
        .order-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .order-modal.active {
            display: flex;
        }

        .order-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* DMPK Styles */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-medium: #1e293b;
            --text-dark: #1e293b;
            --text-medium: #475569;
            --text-light: #64748b;
        }

        .dmpk-sidebar {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid #e2e8f0;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .dmpk-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .dmpk-brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .dmpk-brand-text {
            font-size: 19px;
            font-weight: 900;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }
        
        .dmpk-brand-text span {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dmpk-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .dmpk-form-group label {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--text-light);
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dmpk-form-group label::before {
            content: '';
            width: 3px;
            height: 10px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .dmpk-sidebar select,
        .dmpk-sidebar input,
        .dmpk-sidebar textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 13px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .dmpk-sidebar select:focus,
        .dmpk-sidebar input:focus,
        .dmpk-sidebar textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .dmpk-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .dmpk-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }
        
        .dmpk-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.5);
        }

        .dmpk-content {
            padding: 24px;
            background: white;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .dmpk-header-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .dmpk-service-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        
        .dmpk-service-desc {
            font-size: 12px;
            color: var(--text-medium);
            line-height: 1.5;
        }

        .dmpk-kpi-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .dmpk-kpi-badge {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #bfdbfe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .dmpk-kpi-badge.purple {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border-color: #ddd6fe;
            color: #6d28d9;
        }
        
        .dmpk-kpi-badge.cyan {
            background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
            border-color: #a5f3fc;
            color: #0e7490;
        }

        .dmpk-info-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 3px solid var(--primary);
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-medium);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
        }
        
        .dmpk-info-box-title {
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .dmpk-sim-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #f5f3ff 100%);
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08);
        }
        
        .dmpk-sim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .dmpk-sim-title {
            font-weight: 800;
            font-size: 12px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dmpk-sim-value {
            font-weight: 900;
            color: var(--primary);
            font-size: 14px;
            background: white;
            padding: 5px 12px;
            border-radius: 8px;
            border: 2px solid #e0e7ff;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
        }
        
        .dmpk-sim-description {
            font-size: 10px;
            color: var(--text-medium);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .dmpk-slider input[type=range] {
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            margin: 8px 0;
        }
        
        .dmpk-slider input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
        }
        
        .dmpk-slider input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6);
        }
        
        .dmpk-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-light);
            margin-top: 4px;
            font-weight: 600;
        }

        .dmpk-chart-wrapper {
            height: 280px;
            width: 100%;
            position: relative;
            background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            margin-bottom: 16px;
        }

        @media (max-width: 1024px) {
            .dmpk-modal-content {
                grid-template-columns: 1fr;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body class="font-body antialiased bg-gray-50">
    <div class="flex min-h-screen w-full">
        <!-- Sidebar -->
        <aside class="hidden md:block w-64 bg-gray-50 border-r border-gray-200 fixed h-screen overflow-y-auto">
            <div class="flex flex-col h-full">
                <!-- Header -->
                <div class="flex flex-col gap-2 p-4 border-b border-gray-200">
                    <div class="flex items-center gap-2.5">
                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-blue-600 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                <circle cx="12" cy="12" r="1"></circle>
                                <path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"></path>
                                <path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"></path>
                            </svg>
                        </div>
                        <span class="text-lg font-semibold text-gray-900">MetaFlow</span>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 p-2">
                    <ul class="flex flex-col gap-1">
                        <li>
                            <a href="#" data-page="dashboard" class="nav-link active flex items-center gap-2 rounded-md p-2 text-sm font-medium transition hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="7" height="9" x="3" y="3" rx="1"></rect>
                                    <rect width="7" height="5" x="14" y="3" rx="1"></rect>
                                    <rect width="7" height="9" x="14" y="12" rx="1"></rect>
                                    <rect width="7" height="5" x="3" y="16" rx="1"></rect>
                                </svg>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="orders" class="nav-link flex items-center gap-2 rounded-md p-2 text-sm font-medium transition hover:bg-gray-100 text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2v6a2 2 0 0 0 .245.96l5.51 10.08A2 2 0 0 1 18 22H6a2 2 0 0 1-1.755-2.96l5.51-10.08A2 2 0 0 0 10 8V2"></path>
                                    <path d="M6.453 15h11.094"></path>
                                    <path d="M8.5 2h7"></path>
                                </svg>
                                <span>Test Orders</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="reports" class="nav-link flex items-center gap-2 rounded-md p-2 text-sm font-medium transition hover:bg-gray-100 text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                                    <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
                                    <path d="M10 9H8"></path>
                                    <path d="M16 13H8"></path>
                                    <path d="M16 17H8"></path>
                                </svg>
                                <span>Reports</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="settings" class="nav-link flex items-center gap-2 rounded-md p-2 text-sm font-medium transition hover:bg-gray-100 text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Footer -->
                <div class="p-4 border-t border-gray-200">
                    <div class="rounded-lg bg-blue-50 p-4">
                        <h3 class="font-semibold text-sm text-gray-900">Need Help?</h3>
                        <p class="mt-1 text-xs text-gray-600">Our support team is available to assist you.</p>
                        <button class="mt-3 w-full flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium border border-gray-300 bg-white rounded-lg hover:bg-gray-50 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="m4.93 4.93 4.24 4.24"></path>
                                <path d="m14.83 9.17 4.24-4.24"></path>
                                <path d="m14.83 14.83 4.24 4.24"></path>
                                <path d="m9.17 14.83-4.24 4.24"></path>
                                <circle cx="12" cy="12" r="4"></circle>
                            </svg>
                            Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 md:ml-64">
            <!-- Header -->
            <header class="sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-white px-6">
                <div class="relative flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-3 text-gray-400">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    <input type="search" class="h-10 w-full max-w-md rounded-lg border border-gray-300 bg-gray-50 pl-10 pr-4 text-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20" placeholder="Search tests, compounds..."/>
                </div>
                <div class="flex items-center gap-3">
                    <button class="flex h-10 w-10 items-center justify-center rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.268 21a2 2 0 0 0 3.464 0"></path>
                            <path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"></path>
                        </svg>
                    </button>
                    <div class="flex h-9 w-9 items-center justify-center rounded-full bg-blue-600 text-white text-sm font-semibold cursor-pointer">
                        ER
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="p-6">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content active">
                    <div class="flex flex-col gap-6">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold">Dashboard</h1>
                            <div class="flex gap-2">
                                <button onclick="exportToCSV()" class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                                        <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
                                        <path d="M12 18v-6"></path>
                                        <path d="m9 15 3 3 3-3"></path>
                                    </svg>
                                    Export
                                </button>
                                <button onclick="openDMPKModal()" class="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M8 12h8"></path>
                                        <path d="M12 8v8"></path>
                                    </svg>
                                    New Test Order
                                </button>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                            <div class="rounded-lg border bg-white p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Active Tests</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                    </svg>
                                </div>
                                <div class="text-2xl font-bold" id="statActive">0</div>
                                <p class="text-xs text-gray-500 mt-1" id="statActiveChange">Loading...</p>
                            </div>
                            <div class="rounded-lg border bg-white p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Completed</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                    </svg>
                                </div>
                                <div class="text-2xl font-bold" id="statCompleted">0</div>
                                <p class="text-xs text-gray-500 mt-1" id="statCompletedChange">Loading...</p>
                            </div>
                            <div class="rounded-lg border bg-white p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Avg. Turnaround</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                    </svg>
                                </div>
                                <div class="text-2xl font-bold">4.2 Days</div>
                                <p class="text-xs text-gray-500 mt-1">-0.5 days from last month</p>
                            </div>
                            <div class="rounded-lg border bg-white p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Success Rate</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                    </svg>
                                </div>
                                <div class="text-2xl font-bold">98.2%</div>
                                <p class="text-xs text-gray-500 mt-1">+1.2% from last month</p>
                            </div>
                        </div>

                        <!-- Recent Orders + Calendar -->
                        <div class="grid gap-6 lg:grid-cols-3">
                            <div class="lg:col-span-2 rounded-lg border bg-white shadow-sm">
                                <div class="p-6 border-b">
                                    <h2 class="text-lg font-semibold">Recent Test Orders</h2>
                                    <p class="text-sm text-gray-500 mt-1">An overview of your most recent tests</p>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="border-b bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compound</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Test Type</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="dashboardTableBody" class="divide-y">
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Calendar -->
                            <div class="rounded-lg border bg-white shadow-sm p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold">February 2026</h3>
                                    <div class="flex gap-1">
                                        <button class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded">‚Äπ</button>
                                        <button class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded">‚Ä∫</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center text-xs">
                                    <div class="font-semibold text-gray-500 p-2">S</div>
                                    <div class="font-semibold text-gray-500 p-2">M</div>
                                    <div class="font-semibold text-gray-500 p-2">T</div>
                                    <div class="font-semibold text-gray-500 p-2">W</div>
                                    <div class="font-semibold text-gray-500 p-2">T</div>
                                    <div class="font-semibold text-gray-500 p-2">F</div>
                                    <div class="font-semibold text-gray-500 p-2">S</div>
                                    
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">1</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">2</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">3</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">4</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">5</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">6</div>
                                    <div class="p-2 bg-blue-600 text-white rounded font-semibold">7</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">8</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">9</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">10</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">11</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">12</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">13</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">14</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">15</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">16</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">17</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">18</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">19</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">20</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">21</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">22</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">23</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">24</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">25</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">26</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">27</div>
                                    <div class="p-2 hover:bg-gray-100 rounded cursor-pointer">28</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Orders Page -->
                <div id="page-orders" class="page-content">
                    <div class="flex flex-col gap-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold">Test Orders</h1>
                                <p class="text-sm text-gray-500 mt-1">Manage all your test orders</p>
                            </div>
                            <button onclick="openDMPKModal()" class="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M8 12h8"></path>
                                    <path d="M12 8v8"></path>
                                </svg>
                                New Order
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="flex gap-3">
                            <select id="filterStatus" onchange="filterOrders()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Failed">Failed</option>
                            </select>
                            <select id="filterService" onchange="filterOrders()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20">
                                <option value="">All Services</option>
                                <option value="stability">Metabolic Stability</option>
                                <option value="binding">Protein Binding</option>
                                <option value="permeability">Permeability</option>
                            </select>
                        </div>

                        <!-- Orders Grid -->
                        <div id="ordersGrid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="page-reports" class="page-content">
                    <div class="flex flex-col gap-6">
                        <div>
                            <h1 class="text-2xl font-bold">Reports & Analytics</h1>
                            <p class="text-sm text-gray-500 mt-1">View insights and analytics from your test data</p>
                        </div>

                        <!-- Charts -->
                        <div class="grid gap-6 lg:grid-cols-2">
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">Status Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">Service Type Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="serviceChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="rounded-lg border bg-white shadow-sm p-6">
                            <h3 class="font-semibold mb-4">Orders Timeline</h3>
                            <div class="chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="page-settings" class="page-content">
                    <div class="flex flex-col gap-6">
                        <div>
                            <h1 class="text-2xl font-bold">Settings</h1>
                            <p class="text-sm text-gray-500 mt-1">Manage your account and preferences</p>
                        </div>

                        <div class="grid gap-6 lg:grid-cols-2">
                            <!-- Profile Settings -->
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">Profile Settings</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" value="Evelyn Reed" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" value="evelyn.reed@metaflow.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                        <input type="text" value="Lab Manager" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" disabled/>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                        Save Changes
                                    </button>
                                </div>
                            </div>

                            <!-- Notification Settings -->
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">Notifications</h3>
                                <div class="space-y-4">
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <span class="text-sm font-medium">Email notifications</span>
                                        <input type="checkbox" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-600"/>
                                    </label>
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <span class="text-sm font-medium">Order status updates</span>
                                        <input type="checkbox" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-600"/>
                                    </label>
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <span class="text-sm font-medium">Weekly summary</span>
                                        <input type="checkbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-600"/>
                                    </label>
                                </div>
                            </div>

                            <!-- Data Management -->
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">Data Management</h3>
                                <div class="space-y-3">
                                    <button onclick="exportToCSV()" class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-left flex items-center justify-between">
                                        <span class="text-sm font-medium">Export all data (CSV)</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                                            <path d="M12 18v-6"></path>
                                            <path d="m9 15 3 3 3-3"></path>
                                        </svg>
                                    </button>
                                    <button onclick="clearAllData()" class="w-full px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition text-left flex items-center justify-between">
                                        <span class="text-sm font-medium">Clear all data</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18"></path>
                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- System Info -->
                            <div class="rounded-lg border bg-white shadow-sm p-6">
                                <h3 class="font-semibold mb-4">System Information</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Version</span>
                                        <span class="font-medium">1.0.0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Orders</span>
                                        <span class="font-medium" id="totalOrdersCount">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Storage Used</span>
                                        <span class="font-medium" id="storageUsed">0 KB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Last Backup</span>
                                        <span class="font-medium">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="order-modal">
        <div class="order-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="modalCompoundName">Loading...</h2>
                        <p class="text-sm text-gray-500" id="modalOrderId">ORD-000</p>
                    </div>
                    <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6" id="modalContent"></div>
            <div class="p-6 border-t border-gray-200 flex gap-3">
                <button onclick="closeOrderModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">Close</button>
                <button onclick="deleteCurrentOrder()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Delete Order</button>
            </div>
        </div>
    </div>

    <!-- DMPK Modal -->
    <div id="dmpkModal" class="dmpk-modal">
        <button class="dmpk-close" onclick="closeDMPKModal()">√ó</button>
        
        <div class="dmpk-modal-content">
            <div class="dmpk-sidebar">
                <div class="dmpk-brand">
                    <div class="dmpk-brand-icon">‚ö°</div>
                    <div class="dmpk-brand-text">BioAssay <span>Direct</span></div>
                </div>
                
                <div class="dmpk-form-group">
                    <label>üî¨ 1. Service ausw√§hlen</label>
                    <select id="serviceSelect" onchange="changeService()">
                        <option value="stability">Metabolische Stabilit√§t</option>
                        <option value="binding">Proteinbindung (PPB)</option>
                        <option value="permeability">Caco-2 Permeabilit√§t</option>
                    </select>
                </div>

                <div class="dmpk-form-group">
                    <label>üß¨ 2. Substanz-ID</label>
                    <input type="text" id="compoundId" placeholder="z.B. Compound-K7L9">
                </div>

                <div class="dmpk-form-group">
                    <label>üíß 3. Testkonzentration</label>
                    <input type="number" id="conc" value="1.0" step="0.1" min="0.1">
                    <span style="font-size:10px; color: var(--text-light); margin-top:-4px;">Konzentration in ¬µM</span>
                </div>

                <div class="dmpk-form-group">
                    <label>üí¨ 4. Labor-Notizen</label>
                    <textarea rows="3" id="notes" placeholder="z.B. Lichtempfindlich, schwer l√∂slich..."></textarea>
                </div>

                <div style="margin-top: auto;">
                    <button class="dmpk-btn dmpk-btn-primary" onclick="createNewOrder()">
                        <span>‚úì</span>
                        <span>Order erstellen</span>
                    </button>
                </div>
            </div>

            <div class="dmpk-content">
                <div class="dmpk-header-section">
                    <div class="dmpk-service-title" id="displayTitle">Metabolische Stabilit√§t</div>
                    <div class="dmpk-service-desc" id="displayDesc">Bestimmung der intrinsischen Clearance und Halbwertszeit in Lebermikrosomen.</div>
                </div>

                <div class="dmpk-kpi-row">
                    <div class="dmpk-kpi-badge">‚è±Ô∏è TAT: <strong id="tatValue">5 Werktage</strong></div>
                    <div class="dmpk-kpi-badge purple">üß™ Bedarf: <strong id="sampleValue">50 ¬µL (10mM)</strong></div>
                    <div class="dmpk-kpi-badge cyan">üìä Methode: <strong id="methodValue">LC-MS/MS</strong></div>
                </div>

                <div id="infoStability" class="dmpk-info-box">
                    <div class="dmpk-info-box-title">‚ÑπÔ∏è Was wird gemessen?</div>
                    Metabolische Stabilit√§t misst den enzymatischen Abbau durch CYP-Enzyme in Lebermikrosomen √ºber 60 Min.
                </div>

                <div id="infoBinding" class="dmpk-info-box hidden">
                    <div class="dmpk-info-box-title">‚ÑπÔ∏è Was wird gemessen?</div>
                    Plasmaproteinbindung bestimmt den Anteil an Albumin/Glykoprotein. Nur die freie Fraktion (fu) ist aktiv.
                </div>

                <div id="infoPermeability" class="dmpk-info-box hidden">
                    <div class="dmpk-info-box-title">‚ÑπÔ∏è Was wird gemessen?</div>
                    Caco-2 simuliert die Darmbarriere. Bidirektionaler Transport (A‚ÜíB/B‚ÜíA) zeigt Permeabilit√§t und Efflux.
                </div>

                <div class="dmpk-sim-box">
                    <div class="dmpk-sim-header">
                        <span class="dmpk-sim-title">üß™ Experiment-Simulator</span>
                        <span class="dmpk-sim-value" id="simValueDisplay">t¬Ω = 30 min</span>
                    </div>
                    <div class="dmpk-sim-description" id="simDesc">Simulieren Sie Szenarien, um das Verhalten Ihrer Substanz zu verstehen.</div>
                    
                    <div id="slider-stability" class="dmpk-slider">
                        <input type="range" id="rangeStability" min="5" max="120" value="30" oninput="updateSimulation()">
                        <div class="dmpk-slider-labels">
                            <span>‚ö° Instabil (5 min)</span>
                            <span>üõ°Ô∏è Sehr stabil (120 min)</span>
                        </div>
                    </div>

                    <div id="slider-binding" class="dmpk-slider hidden">
                        <input type="range" id="rangeBinding" min="0" max="100" value="95" oninput="updateSimulation()">
                        <div class="dmpk-slider-labels">
                            <span>üí® Kaum gebunden (0%)</span>
                            <span>üîí Stark gebunden (100%)</span>
                        </div>
                    </div>

                    <div id="slider-permeability" class="dmpk-slider hidden">
                        <input type="range" id="rangePerm" min="0.1" max="5" step="0.1" value="1" oninput="updateSimulation()">
                        <div class="dmpk-slider-labels">
                            <span>‚úÖ Kein Efflux (1.0)</span>
                            <span>‚ö†Ô∏è Starker Efflux (>3.0)</span>
                        </div>
                    </div>
                </div>

                <div class="dmpk-chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DATA MANAGEMENT ==========
        
        const STORAGE_KEY = 'metaflow_orders';
        let currentOrderId = null;
        let currentPage = 'dashboard';

        const services = {
            stability: {
                title: "Metabolische Stabilit√§t",
                desc: "Messung des enzymatischen Abbaus √ºber 60 Minuten in Lebermikrosomen (RLM/HLM).",
                tat: "5 Werktage",
                sample: "50 ¬µL (10mM)",
                method: "LC-MS/MS",
                type: "Liver Microsomes"
            },
            binding: {
                title: "Plasmaproteinbindung",
                desc: "Bestimmung der freien Fraktion (fu) mittels Equilibrium Dialysis.",
                tat: "7 Werktage",
                sample: "100 ¬µL (10mM)",
                method: "Dialyse/UF",
                type: "Protein Binding"
            },
            permeability: {
                title: "Caco-2 Permeabilit√§t",
                desc: "Simulation der intestinalen Absorption via Caco-2 Monolayer.",
                tat: "10 Werktage",
                sample: "75 ¬µL (10mM)",
                method: "Transwell",
                type: "Caco-2"
            }
        };

        const statusConfig = {
            'Pending': { class: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: '‚è≥' },
            'In Progress': { class: 'bg-blue-100 text-blue-800 border-blue-200', icon: 'üî¨' },
            'Completed': { class: 'bg-green-100 text-green-800 border-green-200', icon: '‚úÖ' },
            'Failed': { class: 'bg-red-100 text-red-800 border-red-200', icon: '‚ùå' }
        };

        const compoundColors = ['#4285F4', '#7B1FA2', '#E3F2FD', '#9E9E9E', '#10b981', '#f59e0b'];

        // Initialize demo data
        function initDemoData() {
            const existing = localStorage.getItem(STORAGE_KEY);
            if (existing) return;

            const demoOrders = [
                {
                    id: 'ORD-001',
                    compoundId: 'Compound-A1B2',
                    serviceType: 'stability',
                    testType: 'Liver Microsomes',
                    status: 'Completed',
                    concentration: '1.0',
                    notes: 'Erste Testreihe erfolgreich',
                    createdAt: new Date(2026, 1, 1).toISOString(),
                    progress: 100,
                    color: compoundColors[0]
                },
                {
                    id: 'ORD-002',
                    compoundId: 'Compound-C3D4',
                    serviceType: 'binding',
                    testType: 'Hepatocytes',
                    status: 'In Progress',
                    concentration: '2.5',
                    notes: 'Hohe Proteinbindung erwartet',
                    createdAt: new Date(2026, 1, 3).toISOString(),
                    progress: 75,
                    color: compoundColors[1]
                },
                {
                    id: 'ORD-003',
                    compoundId: 'Compound-E5F6',
                    serviceType: 'stability',
                    testType: 'Liver Microsomes',
                    status: 'In Progress',
                    concentration: '1.5',
                    notes: 'Lichtempfindlich - im Dunkeln lagern',
                    createdAt: new Date(2026, 1, 5).toISOString(),
                    progress: 40,
                    color: compoundColors[2]
                },
                {
                    id: 'ORD-004',
                    compoundId: 'Compound-G7H8',
                    serviceType: 'permeability',
                    testType: 'Hepatocytes',
                    status: 'Pending',
                    concentration: '0.8',
                    notes: 'Warten auf Material',
                    createdAt: new Date(2026, 1, 6).toISOString(),
                    progress: 0,
                    color: compoundColors[3]
                },
                {
                    id: 'ORD-005',
                    compoundId: 'Compound-I9J0',
                    serviceType: 'permeability',
                    testType: 'Hepatocytes',
                    status: 'Completed',
                    concentration: '1.2',
                    notes: 'Gute Permeabilit√§t nachgewiesen',
                    createdAt: new Date(2026, 0, 28).toISOString(),
                    progress: 100,
                    color: compoundColors[4]
                }
            ];

            localStorage.setItem(STORAGE_KEY, JSON.stringify(demoOrders));
        }

        function getOrders() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveOrders(orders) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
        }

        function addOrder(order) {
            const orders = getOrders();
            orders.unshift(order);
            saveOrders(orders);
            updateAllViews();
        }

        function updateOrder(orderId, updates) {
            const orders = getOrders();
            const index = orders.findIndex(o => o.id === orderId);
            if (index !== -1) {
                orders[index] = { ...orders[index], ...updates };
                saveOrders(orders);
                updateAllViews();
            }
        }

        function deleteOrder(orderId) {
            const orders = getOrders();
            const filtered = orders.filter(o => o.id !== orderId);
            saveOrders(filtered);
            updateAllViews();
        }

        function generateOrderId() {
            const orders = getOrders();
            const maxId = orders.reduce((max, o) => {
                const num = parseInt(o.id.split('-')[1]);
                return num > max ? num : max;
            }, 0);
            return `ORD-${String(maxId + 1).padStart(3, '0')}`;
        }

        // ========== NAVIGATION ==========

        function navigateTo(page) {
            currentPage = page;
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            
            // Show current page
            document.getElementById(`page-${page}`).classList.add('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active', 'bg-gray-100', 'font-medium', 'text-gray-900');
                link.classList.add('text-gray-700');
            });
            
            const activeLink = document.querySelector(`[data-page="${page}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'bg-gray-100', 'font-medium', 'text-gray-900');
                activeLink.classList.remove('text-gray-700');
            }

            // Update page-specific content
            if (page === 'orders') {
                renderOrdersPage();
            } else if (page === 'reports') {
                renderReportsPage();
            } else if (page === 'settings') {
                updateSettingsPage();
            }
        }

        // Setup navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                navigateTo(page);
            });
        });

        // ========== DASHBOARD ==========

        function updateDashboard() {
            const orders = getOrders();
            
            // Stats
            const activeCount = orders.filter(o => o.status === 'In Progress' || o.status === 'Pending').length;
            const completedThisMonth = orders.filter(o => {
                const date = new Date(o.createdAt);
                const now = new Date();
                return o.status === 'Completed' && 
                       date.getMonth() === now.getMonth() && 
                       date.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('statActive').textContent = activeCount;
            document.getElementById('statActiveChange').textContent = `${activeCount} orders in progress`;
            document.getElementById('statCompleted').textContent = completedThisMonth;
            document.getElementById('statCompletedChange').textContent = `${completedThisMonth} completed this month`;

            // Table
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = '';

            const recentOrders = orders.slice(0, 5);
            
            recentOrders.forEach(order => {
                const statusInfo = statusConfig[order.status];
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 cursor-pointer transition';
                tr.onclick = () => openOrderDetails(order.id);
                
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-semibold text-sm">${order.compoundId}</div>
                        <div class="text-xs text-gray-500">${order.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold border ${statusInfo.class}">
                            ${statusInfo.icon} ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 hidden md:table-cell text-sm">${order.testType}</td>
                    <td class="px-6 py-4">
                        <button onclick="event.stopPropagation(); openOrderDetails('${order.id}')" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="19" cy="12" r="1"></circle>
                                <circle cx="5" cy="12" r="1"></circle>
                            </svg>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // ========== TEST ORDERS PAGE ==========

        function renderOrdersPage() {
            filterOrders();
        }

        function filterOrders() {
            const orders = getOrders();
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const serviceFilter = document.getElementById('filterService')?.value || '';

            const filtered = orders.filter(order => {
                const matchStatus = !statusFilter || order.status === statusFilter;
                const matchService = !serviceFilter || order.serviceType === serviceFilter;
                return matchStatus && matchService;
            });

            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = '';

            filtered.forEach(order => {
                const statusInfo = statusConfig[order.status];
                const card = document.createElement('div');
                card.className = 'rounded-lg border bg-white p-6 shadow-sm hover:shadow-md transition cursor-pointer';
                card.onclick = () => openOrderDetails(order.id);
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-sm" style="background: ${order.color}">
                            ${order.compoundId.split('-')[1].substring(0,4)}
                        </div>
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold border ${statusInfo.class}">
                            ${statusInfo.icon} ${order.status}
                        </span>
                    </div>
                    <h3 class="font-semibold text-lg mb-1">${order.compoundId}</h3>
                    <p class="text-sm text-gray-500 mb-3">${order.id} ‚Ä¢ ${order.testType}</p>
                    <div class="text-xs text-gray-600">
                        <div class="mb-1"><strong>Service:</strong> ${services[order.serviceType].title}</div>
                        <div class="mb-1"><strong>Conc:</strong> ${order.concentration} ¬µM</div>
                        <div><strong>Created:</strong> ${new Date(order.createdAt).toLocaleDateString('de-DE')}</div>
                    </div>
                    ${order.progress > 0 && order.progress < 100 ? `
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progress</span>
                            <span>${order.progress}%</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600" style="width: ${order.progress}%"></div>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                grid.appendChild(card);
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No orders found</div>';
            }
        }

        // ========== REPORTS PAGE ==========

        let statusChartInstance = null;
        let serviceChartInstance = null;
        let timelineChartInstance = null;
        let chartsInitialized = false;

        function renderReportsPage() {
            const orders = getOrders();

            // Status Distribution
            const statusCounts = {
                'Pending': 0,
                'In Progress': 0,
                'Completed': 0,
                'Failed': 0
            };
            orders.forEach(o => statusCounts[o.status]++);

            // Destroy and recreate properly
            if (statusChartInstance) {
                statusChartInstance.destroy();
                statusChartInstance = null;
            }
            
            const ctx1 = document.getElementById('statusChart');
            if (ctx1) {
                statusChartInstance = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#fbbf24', '#3b82f6', '#10b981', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10,
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            }

            // Service Distribution
            const serviceCounts = {
                'stability': 0,
                'binding': 0,
                'permeability': 0
            };
            orders.forEach(o => serviceCounts[o.serviceType]++);

            if (serviceChartInstance) {
                serviceChartInstance.destroy();
                serviceChartInstance = null;
            }
            
            const ctx2 = document.getElementById('serviceChart');
            if (ctx2) {
                serviceChartInstance = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Metabolic Stability', 'Protein Binding', 'Permeability'],
                        datasets: [{
                            label: 'Orders',
                            data: [serviceCounts.stability, serviceCounts.binding, serviceCounts.permeability],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: 11 }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            }

            // Timeline
            const ordersPerDay = {};
            orders.forEach(o => {
                const date = new Date(o.createdAt).toLocaleDateString('en-US');
                ordersPerDay[date] = (ordersPerDay[date] || 0) + 1;
            });

            const sortedDates = Object.keys(ordersPerDay).sort((a, b) => new Date(a) - new Date(b));

            if (timelineChartInstance) {
                timelineChartInstance.destroy();
                timelineChartInstance = null;
            }
            
            const ctx3 = document.getElementById('timelineChart');
            if (ctx3) {
                timelineChartInstance = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Orders Created',
                            data: sortedDates.map(d => ordersPerDay[d]),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: 11 }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            chartsInitialized = true;
        }

        // ========== SETTINGS PAGE ==========

        function updateSettingsPage() {
            const orders = getOrders();
            document.getElementById('totalOrdersCount').textContent = orders.length;
            
            const storageSize = new Blob([JSON.stringify(orders)]).size;
            document.getElementById('storageUsed').textContent = `${(storageSize / 1024).toFixed(2)} KB`;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL orders? This cannot be undone!')) {
                localStorage.removeItem(STORAGE_KEY);
                initDemoData();
                updateAllViews();
                alert('All data cleared. Demo data restored.');
            }
        }

        // ========== ORDER DETAILS MODAL ==========

        function openOrderDetails(orderId) {
            const orders = getOrders();
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            currentOrderId = orderId;
            const service = services[order.serviceType];

            document.getElementById('modalCompoundName').textContent = order.compoundId;
            document.getElementById('modalOrderId').textContent = order.id;

            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Service Type</label>
                            <p class="text-sm font-medium mt-1">${service.title}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Test Type</label>
                            <p class="text-sm font-medium mt-1">${order.testType}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Concentration</label>
                            <p class="text-sm font-medium mt-1">${order.concentration} ¬µM</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Created</label>
                            <p class="text-sm font-medium mt-1">${new Date(order.createdAt).toLocaleDateString('de-DE')}</p>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Status</label>
                        <select onchange="changeOrderStatus('${order.id}', this.value)" 
                                class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="In Progress" ${order.status === 'In Progress' ? 'selected' : ''}>üî¨ In Progress</option>
                            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>‚úÖ Completed</option>
                            <option value="Failed" ${order.status === 'Failed' ? 'selected' : ''}>‚ùå Failed</option>
                        </select>
                    </div>

                    ${order.progress > 0 && order.progress < 100 ? `
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Progress</label>
                        <div class="mt-2 flex items-center gap-3">
                            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-600 transition-all" style="width: ${order.progress}%"></div>
                            </div>
                            <span class="text-sm font-semibold">${order.progress}%</span>
                        </div>
                    </div>
                    ` : ''}

                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Notes</label>
                        <p class="text-sm mt-1 text-gray-700">${order.notes || 'No notes'}</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-sm text-blue-900 mb-2">Service Details</h4>
                        <div class="space-y-1 text-xs">
                            <p><strong>TAT:</strong> ${service.tat}</p>
                            <p><strong>Sample Required:</strong> ${service.sample}</p>
                            <p><strong>Method:</strong> ${service.method}</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            currentOrderId = null;
        }

        function changeOrderStatus(orderId, newStatus) {
            let updates = { status: newStatus };
            
            if (newStatus === 'Completed') {
                updates.progress = 100;
            } else if (newStatus === 'In Progress' && updates.progress === 0) {
                updates.progress = 25;
            } else if (newStatus === 'Pending') {
                updates.progress = 0;
            }

            updateOrder(orderId, updates);
            openOrderDetails(orderId);
        }

        function deleteCurrentOrder() {
            if (!currentOrderId) return;
            
            if (confirm('Are you sure you want to delete this order? This cannot be undone.')) {
                deleteOrder(currentOrderId);
                closeOrderModal();
            }
        }

        // ========== DMPK MODAL ==========

        let currentChart = null;
        let updateTimeout = null;

        function openDMPKModal() {
            document.getElementById('dmpkModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => changeService(), 100);
        }

        function closeDMPKModal() {
            document.getElementById('dmpkModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function changeService() {
            const serviceKey = document.getElementById('serviceSelect').value;
            const service = services[serviceKey];

            document.getElementById('displayTitle').innerText = service.title;
            document.getElementById('displayDesc').innerText = service.desc;
            document.getElementById('tatValue').innerText = service.tat;
            document.getElementById('sampleValue').innerText = service.sample;
            document.getElementById('methodValue').innerText = service.method;

            document.getElementById('infoStability').classList.toggle('hidden', serviceKey !== 'stability');
            document.getElementById('infoBinding').classList.toggle('hidden', serviceKey !== 'binding');
            document.getElementById('infoPermeability').classList.toggle('hidden', serviceKey !== 'permeability');

            document.getElementById('slider-stability').classList.toggle('hidden', serviceKey !== 'stability');
            document.getElementById('slider-binding').classList.toggle('hidden', serviceKey !== 'binding');
            document.getElementById('slider-permeability').classList.toggle('hidden', serviceKey !== 'permeability');

            updateSimulation();
        }

        function updateSimulation() {
            if (updateTimeout) clearTimeout(updateTimeout);
            
            updateTimeout = setTimeout(() => {
                const serviceKey = document.getElementById('serviceSelect').value;
                
                if (serviceKey === 'stability') {
                    const t12 = document.getElementById('rangeStability').value;
                    document.getElementById('simValueDisplay').innerText = `t¬Ω = ${t12} min`;
                    renderStabilityChart(t12);
                } else if (serviceKey === 'binding') {
                    const bound = document.getElementById('rangeBinding').value;
                    document.getElementById('simValueDisplay').innerText = `${bound}% gebunden`;
                    renderBindingChart(bound);
                } else if (serviceKey === 'permeability') {
                    const ratio = parseFloat(document.getElementById('rangePerm').value);
                    document.getElementById('simValueDisplay').innerText = `Efflux = ${ratio.toFixed(1)}`;
                    renderPermChart(ratio);
                }
            }, 50);
        }

        function destroyChart() {
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
        }

        function renderStabilityChart(t12) {
            const k = 0.693 / parseFloat(t12);
            const times = [0, 10, 20, 30, 45, 60];
            const values = times.map(t => 100 * Math.exp(-k * t));

            if (!currentChart) {
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Verbleibende Substanz (%)',
                            data: values,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        scales: {
                            y: { beginAtZero: true, max: 110 }
                        }
                    }
                });
            } else {
                currentChart.data.datasets[0].data = values;
                currentChart.update('none');
            }
        }

        function renderBindingChart(boundPct) {
            const freePct = 100 - parseFloat(boundPct);
            
            if (!currentChart || currentChart.config.type !== 'doughnut') {
                destroyChart();
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['An Protein gebunden', 'Frei verf√ºgbar'],
                        datasets: [{
                            data: [boundPct, freePct],
                            backgroundColor: ['#cbd5e1', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        animation: { duration: 0 }
                    }
                });
            } else {
                currentChart.data.datasets[0].data = [boundPct, freePct];
                currentChart.update('none');
            }
        }

        function renderPermChart(ratio) {
            const pappAB = 15;
            const pappBA = pappAB * parseFloat(ratio);
            const isHighEfflux = ratio > 2;

            if (!currentChart || currentChart.config.type !== 'bar') {
                destroyChart();
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['A ‚Üí B', 'B ‚Üí A'],
                        datasets: [{
                            label: 'Papp',
                            data: [pappAB, pappBA],
                            backgroundColor: ['#10b981', isHighEfflux ? '#ef4444' : '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } else {
                currentChart.data.datasets[0].data = [pappAB, pappBA];
                currentChart.update('none');
            }
        }

        function createNewOrder() {
            const serviceKey = document.getElementById('serviceSelect').value;
            const compoundId = document.getElementById('compoundId').value || `Compound-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
            const concentration = document.getElementById('conc').value;
            const notes = document.getElementById('notes').value;

            const service = services[serviceKey];

            const newOrder = {
                id: generateOrderId(),
                compoundId: compoundId,
                serviceType: serviceKey,
                testType: service.type,
                status: 'Pending',
                concentration: concentration,
                notes: notes || 'No notes provided',
                createdAt: new Date().toISOString(),
                progress: 0,
                color: compoundColors[Math.floor(Math.random() * compoundColors.length)]
            };

            addOrder(newOrder);
            closeDMPKModal();

            // Reset form
            document.getElementById('compoundId').value = '';
            document.getElementById('conc').value = '1.0';
            document.getElementById('notes').value = '';

            alert(`‚úÖ Order ${newOrder.id} created successfully!`);
        }

        // ========== EXPORT ==========

        function exportToCSV() {
            const orders = getOrders();
            
            let csv = 'Order ID,Compound ID,Service Type,Test Type,Status,Concentration (¬µM),Notes,Created At\n';
            
            orders.forEach(order => {
                csv += `${order.id},${order.compoundId},${services[order.serviceType].title},${order.testType},${order.status},${order.concentration},"${order.notes}",${new Date(order.createdAt).toLocaleDateString('de-DE')}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metaflow-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ========== UPDATE ALL VIEWS ==========

        function updateAllViews() {
            updateDashboard();
            if (currentPage === 'orders') renderOrdersPage();
            if (currentPage === 'reports') renderReportsPage();
            if (currentPage === 'settings') updateSettingsPage();
        }

        // ========== KEYBOARD SHORTCUTS ==========

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDMPKModal();
                closeOrderModal();
            }
            if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                openDMPKModal();
            }
        });

        // ========== INITIALIZATION ==========

        window.addEventListener('load', function() {
            initDemoData();
            updateAllViews();
        });
    </script>
</body>
</html>
